function Histogram(e){Metric.call(this,e);var t=this.n;this.data=d3.range(e.points.length-1).map(function(r,i){return{name:e.points[i].stackName,values:d3.range(t).map(function(){return{time:+e.now,value:0}})}}),this.mostRecent=e.points.map(function(t){return{name:t.stackName,values:{time:+e.now,value:0}}})}function Line(e){Metric.call(this,e),this.data=d3.range(this.n).map(function(){return{time:+e.now,value:0}}),this.mostRecent={time:+e.now,value:0}}allTags=[],metricId=0;var Metric=function(e){this.n=PupController.n(),this.createdAt=new Date,this.uuid=metricId++,this.name=e.metric,this.type=e.type,this.tags=e.tags,this.max=0,this.data=[],this.mostRecent;for(var t=0;t<this.tags.length;t++){var n=this.tags[t];-1===allTags.indexOf(n)&&allTags.push(n)}};Histogram.prototype.updateMostRecent=function(e,t){var n=this.max;this.mostRecent=e.points.map(function(e){return{name:e.stackName,values:e.values.map(function(e){return e[1]>n&&(n=e[1]),{time:e[0]*1e3,value:e[1]}})[0]}}),this.max=n},Histogram.prototype.pushRecent=function(e,t){if(e)this.data=this.data.map(function(e){return e.values.push({time:+t,value:0})});else for(var n=0;n<this.data.length;n++){var r=this.mostRecent[n].values;r.time=+t,this.data[n].values.push(r)}},Histogram.prototype.shiftOld=function(){for(var e=0;e<this.data.length;e++)this.data[e].values.shift()},Histogram.prototype.isTimedOut=function(e,t){return e-d3.min(this.mostRecent,function(e){return e.time})>t?!0:!1},Line.prototype.updateMostRecent=function(e,t){var n=this.max;this.mostRecent=e.points.map(function(e){return e[1]>n&&(n=e[1]),{time:e[0]*1e3,value:e[1]}})[0],this.max=n},Line.prototype.pushRecent=function(e,t){if(e)this.data.push({time:+t,value:0});else{var n=this.mostRecent;n.time=+t,this.data.push(n)}},Line.prototype.shiftOld=function(){this.data.shift()},Line.prototype.isTimedOut=function(e,t){return e-this.mostRecent.time>t?!0:!1};var Store=function(){var e={},t=20,n=!1,r=function(e,t){return e[t].type==="histogram"?metricClass=Histogram:e[t].type!=="histogram"&&(metricClass=Line),new metricClass({now:new Date,metric:t,type:e[t].type,tags:e[t].tags||[],points:e[t].points})},i=function(e){return"Waiting"in e?!1:!0};return pub={},pub.save=function(s){if(i(s)){for(var o in s)if(s.hasOwnProperty(o)){if(!(o in e))if(Object.keys(e).length<t)e[o]=r(s,o);else if(!n)return n=!0,2;o in e&&e[o].updateMostRecent(s[o],o)}return 0}},pub.getMetrics=function(){var t=[];for(var n in e)t.push(e[n]);return t},pub.getMetricByName=function(t){return e[t]},pub}(),PupSocket=function(e,t){var n=!1,r=!1,i=!1;return pub={},pub.isEstablished=function(){return!0===n},pub.tryStart=function(e){if(this.isEstablished())return;var n=new WebSocket("ws://localhost:"+e+"/pupsocket"),s=!0;return n.onmessage=function(e){var n;try{n=JSON.parse(e.data)}catch(r){throw"There was an error parsing the incoming data: "+r}var s=t(n);switch(s){case 0:break;case 1:throw"Malformed data sent to client";case 2:if(!i)var o=document.getElementById("limit-error");o.innerHTML="You have reached the graph count limit. This limit is enforced for reasons of performance.",setTimeout(function(){o.innerHTML=""},5e3),i=!0}},n.onclose=function(){r=!0},n.onerror=function(){s=!1},pub},pub.isClosed=function(){return r},pub}(port,Store.save),MetricGraph=function(e){var t={top:10,right:0,bottom:26,left:45},n=400-t.right,r=140-t.top-t.bottom,i=1.3;this.n=e.n,this.duration=e.duration,this.metric=e.metric,this.element=e.element,this.height=r,this.width=n,this.baseColor=d3.interpolateRgb("#6f56a2","#EADFF5");var s=e.now-(this.n-2)*this.duration,o=e.now-this.duration;this.x=d3.time.scale().domain([s,o]).range([0,n]),this.y=d3.scale.linear().range([r,0]);var u=this.x,a=this.y;this.format=d3.format(".2s"),this.svg=this.element.select(".plot").append("svg").attr("width",n+t.left+t.right).attr("height",r+t.top+t.bottom).style("margin-left",-t.left+10+"px").append("g").attr("transform","translate("+t.left+", "+t.top+")"),this.xAxis=this.svg.append("g").attr("class","x axis").attr("transform","translate(0, "+r+")").call(this.x.axis=d3.svg.axis().scale(this.x).orient("bottom").ticks(5).tickSize(-r).tickPadding(4).tickSubdivide(!0)),this.yAxis=this.svg.append("g").attr("class","y axis").call(this.y.axis=d3.svg.axis().scale(this.y).orient("left").ticks(5).tickFormat(this.format)),this.line=d3.svg.area().interpolate("linear").x(function(e){return u(e.time)}).y0(function(e){return r}).y1(function(e){return a(e.value)}),this.svg.append("defs").append("clipPath").attr("id","clip"+this.metric.uuid).append("rect").attr("width",n).attr("height",r),this.latest=this.element.select(".latest-val").text(""),this.element.append("ul").attr("class","graph-tags").text("tags: ").selectAll("li").data(this.metric.tags).enter().append("li").attr("class","graph-tag").attr("tag",function(e){return e}).text(function(e){return e}),d3.select("#tag-list").selectAll("li").data(allTags).enter().append("li").attr("tag",function(e){return e}).attr("class","tag").text(function(e){return e}),this.updateScales=function(e){this.x.domain([e-(this.n-2)*this.duration,e-this.duration]),this.y.domain([0,i*this.metric.max])}},LineGraph=function(e){MetricGraph.call(this,e);var t=this.baseColor,n=this.svg.append("g").attr("clip-path","url(#clip"+this.metric.uuid+")").append("path").data([this.metric.data]).attr("class","line").attr("id","line"+this.metric.uuid).attr("d",this.line).style("fill",function(e,n){return t(n%5/5)}).style("stroke","#3B226E");this.updateLatestVal=function(){this.latest.text(this.format(this.metric.mostRecent.value))},this.redraw=function(e){d3.select("#line"+this.metric.uuid).attr("d",this.line).attr("transform",null),this.xAxis.call(this.x.axis),this.yAxis.transition().duration(100).ease("linear").call(this.y.axis),n.attr("transform","translate("+this.x(e-(this.n-1)*this.duration)+")")}},HistogramGraph=function(e){MetricGraph.call(this,e);var t=function(e){var t=d3.layout.stack().x(function(e){return e.time}).y(function(e){return e.value}).out(function(e,t,n){e.y0=t,e.y=e.value}),n=e.map(function(e){return e.values}).sort(function(e,t){return e=e[e.length-1].value,t=t[t.length-1].value,e===t?0:e<t?1:-1});return t(n)},n=this.height,r=this.baseColor,i=t(this.metric.data),s=this.metric,o=this.svg.append("g").attr("clip-path","url(#clip"+this.metric.uuid+")").selectAll("path").data(i).enter().append("path").attr("id",function(e,t){return"line"+s.uuid+"-"+t}).attr("class","line").style("fill",function(e,t){return r(1-t%3/3)}).style("stroke","3B226E").attr("d",this.line);this.updateLatestVal=function(){this.latest.text("NA")},this.redraw=function(e){for(var t=0;t<this.metric.data.length;t++)d3.select("#line"+this.metric.uuid+"-"+t).attr("d",this.line).attr("transform",null);this.xAxis.call(this.x.axis),this.yAxis.transition().duration(100).ease("linear").call(this.y.axis);for(var t=0;t<this.metric.data.length;t++)o.attr("transform","translate("+this.x(e-(this.n-1)*this.duration)+")")}},PupController=function(e,t,n){var r=10,i=Math.sqrt(r*60*1e3),s=Math.ceil(i),o=0,u=1e4,a=new Date(Date.now()-i),f=!1,l=[],c={},h={},p=d3.format(".2s"),d=function(e){var t=d3.select("#metric-list").append("li").attr("id","li"+e.uuid).attr("name",e.name).attr("time",+e.createdAt).attr("class",e.type);t.append("span").attr("class","li-metric").attr("x",3).attr("y",12).text(e.name),t.append("span").attr("class","li-val").attr("x",150).attr("y",12).text(""),n(t[0]).hide().fadeIn(500),h[e.name]=t},v=function(e){var t=d3.select("#graphs").append("div").attr("id",e.name).attr("name",e.name).attr("time",+e.createdAt).attr("class","plot-box"),r=t.append("div").attr("class","metric-head");r.append("span").attr("class","latest-val"),r.append("h5").attr("class","metric-name").text(e.name),r.append("a").attr("href",e.name),e.type!=="histogram"&&r.append("a").attr("class","csv").attr("name",e.name).text("CSV");var o=t.append("div").attr("class","plot");e.type==="histogram"?c[e.name]=new HistogramGraph({metric:e,element:t,n:s,duration:i,now:+a}):e.type!=="histogram"&&(c[e.name]=new LineGraph({metric:e,element:t,n:s,duration:i,now:+a})),pub.interact().sort().byActive(),n("#waiting, #no-metrics").addClass("hidden"),n("#graphs, #data-streaming").removeClass("hidden")},m=function(){n("#graphs").empty(),n("#waiting").addClass("hidden"),n("#data-streaming").addClass("hidden"),n("#disconnected").removeClass("hidden"),n("#listening").html("Not "+n("#listening").html())},g=function(e){e.type==="histogram"?h[e.name].select(".li-val").text("NA"):h[e.name].select(".li-val").text(p(e.mostRecent.value))},y=function(){var n=setInterval(function(){e()&&(f=!1,m(),clearTimeout(n)),a=new Date,l=t.getMetrics();for(var r=0;r<l.length;r++){var i=l[r],s=c[i.name],o=i.isTimedOut(a,u);undefined==s&&(d(i),v(i),s=c[i.name]),s.updateScales(a),i.pushRecent(o,a),s.redraw(a),i.shiftOld(),s.updateLatestVal(),g(i)}},i+o+.5)};return pub={},pub.tryStart=function(){return f?0:(f=!0,setTimeout(function(){y()},0),1)},pub.interact=function(){var e,r,i=function(){n("#if-more").removeClass("hidden").detach().appendTo("#content"),n("#num-more").html(r-e),n("#dot").addClass("hidden")},s=function(e,t){CSVWindow=window.open(),CSVWindow.document.title=e,CSVWindow.document.write("timestamp,value</br>");for(var n=0;n<t.length;n++){var r="";for(var i in t[n])r!=""&&(r+=","),r+=t[n][i];CSVWindow.document.write(r+"</br>")}};return intPub={},intPub.updatePlotCount=function(){var t=document.getElementById("graphs").children,i=0;n(t).each(function(){n(this).is(":visible")&&i++}),e=i,r=t.length},intPub.filterBy=function(t){var s=document.getElementById("graphs").children,o=document.getElementById("metric-list").children,u=t.toLowerCase(),a=s.length;while(a--){var f=s[a].id,l=f.toLowerCase(),c=new RegExp(u,"gi");l.match(c)?(s[a].style.display="",o[a].style.display=""):(s[a].style.display="none",o[a].style.display="none")}intPub.updatePlotCount(),e<r?i():(n("#if-more").addClass("hidden"),n("#dot").removeClass("hidden"))},intPub.sort=function(){var e=document.getElementById("graphs"),t=e.children,r=document.getElementById("metric-list"),i=r.children,s=[],o=[],u=t.length,a=function(){var e=0;while(e<u)s.push(t[e]),o.push(i[e]),e++},f=function(){s.length=0,o.length=0},l=function(){for(var t=0;t<u;t++)e.appendChild(s[t]),r.appendChild(o[t])},c=function(e){return console.log(e),e.sort(function(e,t){return e=e.getAttribute("name"),t=t.getAttribute("name"),e===t?0:e<t?-1:1})},h=function(e){return e.sort(function(e,t){return e=parseInt(e.getAttribute("time")),t=parseInt(t.getAttribute("time")),e===t?0:e<t?-1:1})};return sortPub={},sortPub.byName=function(){a(),s=c(s),o=c(o),l(),f()},sortPub.byTimeAdded=function(){a(),s=h(s),o=h(o),l(),f()},sortPub.byActive=function(){var e=n(".active")[0].getAttribute("id");e==="by-name"?sortPub.byName():sortPub.byTimeAdded()},sortPub},intPub.filterByTags=function(s){var o=document.getElementById("graphs").children,u=document.getElementById("metric-list").children,a=document.getElementById("tag-list").children,f=o.length,l=s[0],c;if(n(l).hasClass("tag-active")){n(l).removeClass("tag-active"),n(".graph-tag").each(function(){n(this).html()===n(l).html()&&n(this).css("color","#999")});var h=[];for(var p=0;p<a.length;p++)n(a[p]).hasClass("tag-active")&&h.push(a[p].getAttribute("tag"));while(f--){c=o[f].getAttribute("name");var d=t.getMetricByName(c).tags,p=h.length;if(!h.length)o[f].style.display="",u[f].style.display="";else{while(p--)if(d.indexOf(h[p])>-1)break;p||(o[f].style.display="",u[f].style.display="")}}var v=n("#query").val();v.length&&intPub.filterBy(v),intPub.updatePlotCount(),e<r?i():(n("#if-more").addClass("hidden"),n("#dot").removeClass("hidden"))}else{n(l).addClass("tag-active"),n(".graph-tag").each(function(){n(this).html()===n(l).html()&&n(this).css("color","#6f56a2")});while(f--)c=o[f].getAttribute("name"),-1===t.getMetricByName(c).tags.indexOf(l.getAttribute("tag"))&&(o[f].style.display="none",u[f].style.display="none");intPub.updatePlotCount(),i()}return intPub},intPub.highlightGraph=function(e){var t=n(".plot-box[name="+e+"] h5");n(t).css("background-color","#EADFF5");var r=n(".li[name="+e+"]");return n(r).css("background-color","#EADFF5"),intPub},intPub.scrollToGraph=function(e){var t=n(".plot-box[name="+e+"]"),r=n(t).offset().top;return window.scrollTo(0,r),intPub},intPub.fadeGraph=function(e){var t=n(".plot-box[name="+e+"] h5");n(t).css("background-color","white");var r=n(".li[name="+e+"]");return n(r).css("background-color","transparent"),intPub},intPub.downloadCSV=function(e){metric=t.getMetricByName(e),metric.type!="histogram"&&s(metric.name,metric.data)},intPub},pub.n=function(){return s},pub}(PupSocket.isClosed,Store,$);